@ECHO OFF
SETLOCAL DISABLEDELAYEDEXPANSION

SET WORKING_PATH=%~1
SET FILE_PATH=%~2
SET SNOWSQL_DATABASE=%~3
SET SNOWSQL_WAREHOUSE=%~4
SET FULL_PATH=%FILE_PATH%tbldata_download.sql

break>"%FULL_PATH%"

IF EXIST "%WORKING_PATH%" (
	ECHO USE ROLE DB_DEV; >> "%FULL_PATH%"
) ELSE (
	ECHO USE ROLE DB_OPS; >> "%FULL_PATH%"
)
ECHO. >> "%FULL_PATH%"

SETLOCAL ENABLEDELAYEDEXPANSION
ECHO USE WAREHOUSE %SNOWSQL_WAREHOUSE%; >> "%FULL_PATH%"
ECHO. >> "%FULL_PATH%"

FOR %%A IN ("%FILE_PATH%"*.txt) DO (
	SETLOCAL ENABLEDELAYEDEXPANSION
	SET TABLE_NAME=%%~nA
	SET STAGING_TABLE_NAME=!TABLE_NAME:.=.%%!
	
	ECHO COPY INTO @!SNOWSQL_DATABASE!.!STAGING_TABLE_NAME!/unload/!TABLE_NAME!.txt >> "%FULL_PATH%"
	ECHO FROM !SNOWSQL_DATABASE!.!TABLE_NAME! >> "%FULL_PATH%"
	ECHO FILE_FORMAT = ^( >> "%FULL_PATH%"
	ECHO     FORMAT_NAME = 'ADM.FORMAT_FILE_DEL_TAB' >> "%FULL_PATH%"
	ECHO     EMPTY_FIELD_AS_NULL = FALSE >> "%FULL_PATH%"
	ECHO     COMPRESSION = NONE >> "%FULL_PATH%"
	ECHO ^) >> "%FULL_PATH%"
	ECHO SINGLE = TRUE >> "%FULL_PATH%"
	ECHO OVERWRITE = TRUE; >> "%FULL_PATH%"
	ECHO. >> "%FULL_PATH%"

	ECHO GET @!SNOWSQL_DATABASE!.!STAGING_TABLE_NAME!/unload/!TABLE_NAME!.txt file://%~dp0; >> "%FULL_PATH%"
	ECHO. >> "%FULL_PATH%"
	ECHO. >> "%FULL_PATH%"
	
	SETLOCAL DISABLEDELAYEDEXPANSION
)

SETLOCAL DISABLEDELAYEDEXPANSION